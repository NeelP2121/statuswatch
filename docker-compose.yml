version: "3.9"

services:
  statuswatch:
    build:
      context: .
      dockerfile: Dockerfile
    image: statuswatch:latest
    container_name: statuswatch
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Set this to your Statuspage webhook secret to enable HMAC verification.
      # Leave empty (or omit) to accept all incoming webhooks without checking.
      - STATUSPAGE_WEBHOOK_SECRET=${STATUSPAGE_WEBHOOK_SECRET:-}
    healthcheck:
      test: ["CMD", "python", "-c",
             "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── Optional: ngrok tunnel for local testing ────────────────────────────────
  # Uncomment to expose your local receiver to the internet so you can register
  # the public URL as a Statuspage webhook endpoint during development.
  #
  # ngrok:
  #   image: ngrok/ngrok:latest
  #   command: http statuswatch:8000
  #   environment:
  #     - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
  #   ports:
  #     - "4040:4040"   # ngrok dashboard
  #   depends_on:
  #     - statuswatch
